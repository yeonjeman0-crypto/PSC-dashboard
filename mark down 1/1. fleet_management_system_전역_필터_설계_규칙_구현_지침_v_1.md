# ① 제목
FLEET MANAGEMENT SYSTEM — 전역 필터 설계·규칙·구현 지침(v1.0)

최신 확인 완료: 2025-08-23 (Asia/Seoul)

---

# ② 핵심 요약(3~5줄)
- 제품 정식명은 **FLEET MANAGEMENT SYSTEM(FMS)**으로 확정합니다. 내비·타이틀·파비콘·로고 파일명을 모두 갱신합니다.
- 전 화면 공통 **전역 필터 바**를 상단 고정하고, **기간→MOU→국가→항만→선종→DOC→Owner** 순으로 의존관계를 강제합니다.
- 허용 ENUM: Type=**PC(T)C|BULK**, DOC=**Doublerich Shipping|Doriko Ltd**. 이외 값은 입력·표시에 불가합니다.
- 필터 상태는 **URL 쿼리+로컬스토리지 동기화**, 페이지 간 이동 시 보존, "초기화" 버튼으로 즉시 기본값 복원합니다.

---

# ③ 상세 내용

## 3.1 브랜드·네이밍 반영(필수)
- 제품명: **FLEET MANAGEMENT SYSTEM**
- 네비 브랜드 텍스트: `FLEET MANAGEMENT SYSTEM`
- 로고 경로: `src/assets/brand/logo.svg`(앵커+방패, Indigo #6366f1)
- 파비콘: `src/assets/brand/favicon.ico`
- HTML 타이틀: 모든 페이지 `<title>FLEET MANAGEMENT SYSTEM</title>`

## 3.2 전역 필터 바(구성요소·순서·의존)
상단 고정 바에 다음 컴포넌트를 **왼→오른쪽** 순서로 배치합니다.
1) **기간(Date Range)**: `from`·`to` (기본: 최근 12개월, Asia/Seoul, ISO `YYYY-MM-DD`)
2) **MOU**: 멀티 선택. 허용: `Tokyo, Paris, USCG, Riyadh, Mediterranean, Indian`
3) **국가(Country)**: 멀티. ISO2 코드 셀렉터 + 자동완성(국가명)
4) **항만(UN/LOCODE)**: 멀티. 5자 코드 + 자동완성(포트명). **국가 선택 시 해당 국가로 한정**
5) **선종(Type)**: 라디오 또는 멀티. 허용: **PC(T)C, BULK**
6) **DOC**: 멀티. 허용: **Doublerich Shipping, Doriko Ltd**
7) **Owner**: 멀티. 정규 Owner 5사 목록. 자동완성. (정규화 맵 외 선택 불가)
8) **액션코드(Action)**: 멀티. `actionCodes.json` 기준(10,16,17,18,30,46,48,49,99)
9) **결함코드(Def. Code)**: 멀티. `defCodes.json`(5자리) 기반. 미보강 시 비활성
10) **고급 필터**(슬라이더/체크): `Risk score(0–100)`, `Detained only`
11) 버튼: **Apply**, **Reset**(기본값 복원), **Export**(현재 필터로 CSV)

> **의존 규칙**: 기간 → MOU → 국가 → 항만 → 선종·DOC·Owner(독립) → 액션·결함(독립). 앞 단계 변경 시 뒤 단계 선택값을 자동 교정(유효치만 유지)합니다.

## 3.3 기본값·형식 규칙
- 기간 기본: `to=today(Asia/Seoul)` / `from=to-12M+1day` (예: 2024-08-24~2025-08-23 범위)
- 프리셋: 3M/6M/12M/24M 버튼 제공
- 멀티 선택 UI: 6개 이상 선택 시 `n selected` 요약 배지 표시
- 정합성: LOCODE는 **대문자 5자**만 허용. Type/DOC는 ENUM 밖 값 거부

## 3.4 URL·상태 동기화
- 쿼리 스키마 예시:  
`?from=2025-01-01&to=2025-08-23&mou=Tokyo,USCG&country=KR,JP&locode=KRPNK,JPIMB&type=BULK&doc=Doriko%20Ltd&owner=DORIKO%20LTD&action=17,30&def=05106&risk=60-100&detained=1`
- 파싱 규칙: 쉼표 구분, 대소문자 무시(표시는 정규 라벨)
- 로컬스토리지 키: `fms.filters.v1`
- 페이지 진입 시 순서: URL→LocalStorage→기본값

## 3.5 적용 파이프라인(프런트)
1) **수집**: 폼 값 → 표준 객체 `F = {from,to,mou[],country[],locode[],type[],doc[],owner[],action[],def[],risk:[min,max],detained:boolean}`
2) **검증**: ENUM·형식 검사. 위반 항목 제거 및 사용자 배지 경고
3) **전달**: 각 페이지 Store에 브로드캐스트(`filters:changed` 이벤트)
4) **집계**:
   - KPI → `inspections/deficiencies` 전체 필터 적용 후 계산
   - 차트/테이블 → 동일 필터 적용 후 그룹바이
5) **렌더**: 성공 시 URL 갱신, 로컬스토리지 저장

## 3.6 페이지별 필터 사용 범위(동일 규칙 적용)
- **Dashboard**: 전 필터 사용. KPI·Top Bar·Donut·Heat Table 동기화
- **Inspections**: 전 필터 + `Action`·`Detained only` 적극 사용
- **Deficiencies**: 전 필터 + `Def. Code`·`Category` 중심(Paris 트리 연동)
- **Vessels**: 전 필터 + `Age(builtYear→range)` 보조 슬라이더(옵션)
- **Ports Map**: 전 필터 중 `국가/항만` 우선. 좌표 미보강 시 랭킹·추이 카드로 대체
- **Risk**: 전 필터 + `Risk score` 필수. `Probability/Seriousness` 범주 필터(1–5)
- **Reports**: 전 필터 스냅샷을 문서 헤더에 고정 기재
- **Settings**: 필터 없음(미리보기용 샘플 버튼 제공)

## 3.7 검증·정규화(데이터 측)
- Type: 입력 문자열에 `PCC|PCTC` 포함 → **PC(T)C**로 매핑. `BULK` 외 변형은 태그 분리 후 **BULK**
- DOC: Owner→DOC 매핑. **둘 중 하나**가 아니면 저장·표시 금지
- Owner: 정규 Owner 5사 맵과 일치. 미일치 시 선택 불가
- LOCODE: `/^[A-Z]{5}$/`. 미일치 값 제거

## 3.8 UX 규칙(불변)
- 필터 바 **항상 56px 높이**. 폼 내부 패딩 12px
- 입력 폭: 날짜 220px, 멀티 셀렉트 240px, LOCODE 320px(검색 폭 넓게)
- 버튼 간격 8px, Apply 버튼은 `primary(#6366f1)` 고정
- "초기화"는 **기간만 12M 기본으로 복원**하고 나머지는 전체 선택 해제
- 필터 칩: 적용된 항목은 바 아래 슬림 칩으로 나열, X 클릭 시 해당 항목만 제거

## 3.9 코드 스니펫(요약)
```js
const DEFAULTS=(()=>{const to=todayKST();return{from:addMonths(to,-12).add(1,'day'),to,mou:[],country:[],locode:[],type:[],doc:[],owner:[],action:[],def:[],risk:[0,100],detained:false}})();
function parseFilters(){ /* URL→Object, ENUM 검증, 대문자/트림 */ }
function applyFilters(F){
  if(!valid(F)) F=coerce(F);
  bus.emit('filters:changed',F);
  saveToURL(F); saveToLocal(F);
}
```

## 3.10 테스트 케이스(샘플)
1) 기간 미입력 → 기본 12M 적용
2) MOU=Tokyo,USCG + Country=KR + LOCODE=KRPNK → Inspections 감소 검증
3) Type=BULK + DOC=Doriko Ltd → Vessels 목록이 BULK/Doriko만 남음
4) Action=17 + Detained only → KPI Detentions≥1이면 테이블 행 전부 `detained=true`
5) Def. Code=05106 → Deficiencies 차트·테이블 모두 해당 코드로 제한
6) LOCODE 소문자 입력 → 대문자 자동 변환
7) 잘못된 코드 입력 → 즉시 제거 및 경고 배지 표시
8) Reset → 기간만 복원, 나머지 해제
9) 페이지 이동(`/deficiencies.html`) 후 필터 보존 확인
10) URL 공유 → 동일 필터 상태 재현

---

# ④ 표·리스트

## A. 필터 정의 표(필수)
| 키 | 타입 | 예시 | 기본값 | 검증/허용 |
|---|---|---|---|---|
| from | date | 2025-01-01 | today-12M+1d | ISO8601, KST |
| to | date | 2025-08-23 | today | ISO8601, KST |
| mou | string[] | ["Tokyo","USCG"] | [] | 고정 ENUM |
| country | string[] | ["KR","JP"] | [] | ISO2 |
| locode | string[] | ["KRPNK","JPIMB"] | [] | `/^[A-Z]{5}$/` |
| type | string[] | ["BULK"] | [] | **PC(T)C|BULK** |
| doc | string[] | ["Doriko Ltd"] | [] | **두 값만** |
| owner | string[] | ["DORIKO LTD"] | [] | 정규 Owner 5사 |
| action | string[] | ["17","30"] | [] | actionCodes.json |
| def | string[] | ["05106"] | [] | defCodes.json(5자리) |
| risk | [min,max] | [60,100] | [0,100] | 0≤min≤max≤100 |
| detained | boolean | true | false | 체크박스 |

## B. 페이지별 사용 범위 표
| 페이지 | 필터 사용 | 비고 |
|---|---|---|
| Dashboard | 전 항목 | KPI·차트·Heat Table 동기화 |
| Inspections | 전 항목 | Action·Detained 강조 |
| Deficiencies | 전 항목 | Def. Code 없을 땐 비활성 |
| Vessels | 전 항목 | Age 슬라이더(옵션) |
| Ports Map | 기간·MOU·국가·항만 | 좌표 전 랭킹·추이 대체 |
| Risk | 전 항목 + Risk | 5×5 매트릭스 |
| Reports | 전 항목 | 헤더에 스냅샷 기록 |

## C. 위반 처리(레드라인)
- ENUM 밖 값은 즉시 제거하고 경고 배지 표시: "허용되지 않는 값 제거: {키}:{값}"
- LOCODE 형식 불일치 항목은 **자동 대문자화→재검증**, 실패 시 미적용
- Owner 미정규 항목은 선택 불가

## D. 구현 체크리스트
- [ ] 네비·타이틀 명칭 **FLEET MANAGEMENT SYSTEM** 적용
- [ ] 전역 필터 바 11요소 배치·동작
- [ ] URL·LocalStorage 동기화
- [ ] 의존 규칙(국가→항만) 적용
- [ ] Reset 동작(기간만 복원)
- [ ] 각 페이지 집계가 동일 필터로 재계산

